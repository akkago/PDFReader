const { parsePageContent } = require('../parsePageContent');

describe('parsePageContent', () => {
  test('basic functionality works', () => {
    const pageContents = [['test', '1110', '100', '200', '300']];
    const result = parsePageContent(pageContents);
    expect(result.otchetnost).toBeDefined();
    expect(Array.isArray(result.otchetnost)).toBe(true);
  });

  test('should parse balance sheet data correctly', () => {
    const pageContents = [
      ['Бухгалтерский баланс', 'на 30 сентября 2024 г.', 'Коды', 'Форма по ОКУД', '0710001', 'Дата (число, месяц, год)', '30', '09', '2024', 'Организация', 'Акционерное общество "ПРОММОНТАЖСТРОЙ"', 'по ОКПО', '57932545', 'ф', 'ИHH', '7805235431', 'Вид экономической', 'Работы строительные специализированные, не включенные в', 'по', 'оквэд 2', '43.99.5', 'деятельности', 'другие группировки', 'Организационно-правовая форма /форма собственности', 'Непубличные акционерные', '12267', '16', 'общества', 'по ОКОПФ / ОКФС', '/Частная собственность', 'Единица измерения:', 'в тыс. рублей', 'по ОКЕИ', '384', 'Местонахождение (адрес)', '191180, Санкт-Петербург г, Гороховая ул, дом 67, литера А, помещение 14н', 'Бухгалтерская отчетность подлежит обязательному аудиту', 'ДА', 'HET', 'Наименование аудиторской организации/фамилия, имя, отчество (при наличии) индивидуального аудитора', 'Идентификационный номер налогоплательщика аудиторской организации/индивидуального', 'IHH', 'аудитора', 'Основной государственный регистрационный номер аудиторской', 'ОГРН/', '', 'ОГРНИП', 'Код', 'На 30 сентября', 'На 31 декабря', 'На 31 декабря', 'Пояснения', 'Наименование показателя', '2024г.', '2023г.', '2022r.', 'АКТИВ', 'I. ВНЕОБОРОТНЫЕ АКТИВЫ', 'Нематериальные активы', '1110', '-', 'Результаты исследований и разработок', '1120', '-', '-', '-', 'Нематериальные поисковые активы', '1130', '-', '-', '-', 'Материальные поисковые активы', '1140', '-', '-', 'Основные средства', '1150', '37 992', '24100', '26 048', 'в том числе:', 'Основные средства в организации', '11501', '32 992', '19 100', '21 048', 'Права пользования активами', '11502', '5000', '5000', '5000', 'Доходные вложения в материальные', '1160', 'ценности', '.', '-', 'Финансовые вложения', '1170', '95653', '95653', '95653', 'в том числе:', 'Паи', '11701', '95653', '95653', '95653', 'Отложенные налоговые активы', '1180', '-', '-', '-', 'Прочие внеоборотные активы', '1190', '-', '-', 'Итого по разделу 1', '1100', '133645', '119 753', '121701', 'II. ОБОРОТНЫЕ АКТИВЫ', 'Запасы', '1210', '1 404 416', '919 272', '852699', 'в том числе:', 'Материалы', '12101', '97 528', '78 834', '78 580', 'Товары', '12102', '5467', '5 467', '188', 'Основное производство', '12103', '1301 421', '834 971', '773 931', 'Налог на добавленную стоимость по', '1220', 'приобретенным ценностям', '723', '-', '-', 'в том числе:', 'НДС по приобретенным', '12201', '-', '696', 'материально-производственным запасам', '-'],
      ['НДС по приобретенным услугам', '12202', '27', '-', '-', 'Дебиторская задолженность', '1230', '2 040 731', '1 450 868', '1417123', 'в том числе:', 'Расчеты с поставщиками и подрядчиками', '12301', '1531 194', '1 120 054', '762725', 'Расчеты с покупателями и заказчиками', '12302', '453 915', '288 733', '619 211', 'Расчеты по налогам и сборам', '12303', '3693', '228', '877', 'Расчеты с подотчетными лицами', '12304', '9', '-', '-', 'Расчеты с персоналом по прочим', '12305', 'операциям', '550', '550', '550', 'Расчеты с разными дебиторами и', '12306', 'кредиторами', '51370', '41303', '33 760', 'Финансовые вложения (за исключением', '1240', '48 926', '78 926', '49 926', 'денежных эквивалентов)', 'в том числе:', '12401', 'Предоставленные займы', '48 926', '78 926', '49 926', 'Денежные средства и денежные', '1250', '328 700', '470108', '309 607', 'эквиваленты', 'в том числе:', '12501', '324 022', '467390', '309 489', 'Расчетные счета', '12502', '4678', '2718', '118', 'Прочие специальные счета', '1260', '13 075', '21082', '61652', 'Прочие оборотные активы', 'в том числе:', '12601', '21082', '61652', 'Расходы будущих периодов', '13 075', '2940256', '2691730', 'Итого по разделу II', '1200', '3 835 848', '3 060 009', '2813431', '5АAHC', '1600', '3 969 493'],
      ['Форма 0710001 с.2', 'Пояснения', 'Код', 'На 30 сентября', 'Наименование показателя', 'На 31 декабря', 'На 31 декабря', '2024г.', '2023 г.', '2022r.', 'ПАССИВ', 'III. КАПИТАЛ И РЕЗЕРВЫ', 'Уставный капитал (складочный капитал,', '1310', 'уставный фонд, вклады товарищей)', '210', '210', '210', 'Собственные акции, выкупленные у', '1320', 'акционеров', 'Переоценка внеоборотных активов', '-', '-', '1340', '-', 'Добавочный капитал(без переоценки)', '-', '-', '1350', '372100', '372 100', '372100', 'Резервный капитал', '1360', '-', '-', 'Нераспределенная прибыль(непокрытый', '-', 'убыток)', '1370', '39 645', '32628', '28623', 'Итого по разделу II', '1300', '411 955', '404938', '400933', 'IV. ДОЛГОСРОЧНЫЕ ОБЯЗАТЕЛЬСТВА', 'Заемные средства', '1410', 'Отложенные налоговые обязательства', '-', '-', '1420', '-', '-', 'Оценочные обязательства', '1430', '-', 'Прочие обязательства', '-', '-', '1450', 'Итого по разделу IV', '-', '-', '1400', '-', '-', 'V. КРАТКОСРОЧНЫЕ ОБЯЗАТЕЛЬСТВА', 'Заемные средства', '1510', '20 000', '943', 'в том числе:', '-', 'Краткосрочные займы', '15101', '20 000', '943', '-', 'Кредиторская задолженность', '1520', '3 557538', '2635 071', '2411 555', 'в том числе:', 'Расчеты с поставщиками и подрядчиками', '15201', '1575 741', '1401 885', '1 139 830', 'Расчеты с покупателями и заказчиками', '15202', '1812979', '1 079 184', '1 123 885', 'Расчеты по налогам и сборам', '15203', '6990', '5272', '1202', 'Расчеты по социальному страхованию и', '15204', 'обеспечению', '526', '387', '382', 'Расчеты с персоналом по оплате труда', '15205', '1482', '81', '1158', 'Расчеты с подотчетными лицами', '15206', '-', '-', '314', 'Расчеты с разными дебиторами и', '15207', 'кредиторами', '159 820', '148 262', '144784', 'Доходы будущих периодов', '1530', '-', '-', 'Оценочные обязательства', '-', '1540', '-', '-', 'Прочие обязательства', '1550', '-', '-', 'Итого по разделу V', '1500', '3557 538', '2655 071', '2412498', '5АAHC', '1700', '3 969 493', '3 060 009', '2813431', 'F', 'ОГРH', 'Руководитель', 'Иванова Татьяна', '(подпись)', 'Николаевна', '(расшифровка подписи)']
    ];

    const result = parsePageContent(pageContents);
    
    expect(result.error).toBeUndefined();
    expect(Array.isArray(result.otchetnost)).toBe(true);
    
    const foundCodes = new Set(result.otchetnost.map(r => r.code));
    expect(foundCodes.has('1110')).toBe(true);
    expect(foundCodes.has('1150')).toBe(true);
    expect(foundCodes.has('1170')).toBe(true);
    expect(foundCodes.has('1210')).toBe(true);
    expect(foundCodes.has('1230')).toBe(true);
    expect(foundCodes.has('1310')).toBe(true);
    expect(foundCodes.has('1520')).toBe(true);
    
    const code1150 = result.otchetnost.filter(r => r.code === '1150');
    expect(code1150).toHaveLength(3);
    expect(code1150.find(r => r.date === '2024-09-30').sum).toBe(37992);
    expect(code1150.find(r => r.date === '2023-12-31').sum).toBe(24100);
    expect(code1150.find(r => r.date === '2022-12-31').sum).toBe(26048);
    
    expect(foundCodes.has('1440')).toBe(false);
  });

  test('should parse P&L data correctly', () => {
    const pageContents = [
      ['', 'за Январь - Сентябрь 2024 г.', 'Коды', 'Форма по ОКУД', '0710002', 'Дата (число, месяц, год)', '30', '09', '2024', 'Организация', 'Акционерное общество "ПРОммОНТАЖСТРОЙ"', 'по ОКПО', '57932545', 'Идентификационный номер налогоплательщика', 'ИHH', '7805235431', 'Вид экономической', 'Работы строительные специализированные, не включенные в', 'по', '43.99.5', 'деятельности', 'другие группировки', 'оКвэд 2', 'Организационно-правовая форма /форма собственности', 'Непубличные акционерные', '12267', '16', 'общества', '/Частная собственность', 'по ОКОПФ / ОКФС', 'Единица измерения:', 'в тыс. рублей', 'по ОКЕИ', '384', 'Пояснения', 'За Январь -', 'За Январь -', 'Наименование показателя', 'Код', 'Сентябрь 2024 г.', 'Сентябрь 2023 г.', 'Выручка', '2110', '1327 023', '1 309 986', 'Себестоимость продаж', '2120', '(1 196 001)', '(1 211618)', 'Валовая прибыль (убыток)', '2100', '131 022', '98368', 'Коммерческиерасходы', '2210', '-', 'Управленческие расходы', '2220', '(37134)', '(29 287)', 'Прибыль (убыток) от продаж', '2200', '93 888', '69 081', 'Доходы от участия в других организациях', '2310', '-', 'Проценты к получению', '2320', '-', 'Проценты к уплате', '2330', '-', 'Прочие доходы', '2340', '20291', '28873', 'в том числе:', 'Доходы, связанные с реализацией основных', '23401', 'средств', '283', '3782', 'Доходы по операциям с финансовыми', 'инструментами срочных сделок,не', '23402', ' к', '-', 'Прочие операционные доходы', '23403', '-', '169', 'Штрафы, пени, неустойки к получению', '23404', '455', '190', 'Доходы в виде списанной кредиторской', '23405', 'задолженности', '19 553', '24732', 'Прочие внереализационные доходы', '23406', '-', 'Прочие расходы', '2350', '(105 055)', '(95 002)', 'в том числе:', 'Расходы, связанные с реализацией основных', '23501', 'средств', '(2)', '(182)', 'Расходы по операциям с финансовыми', 'инструментами срочных сделок,не', '23502', '  ', '-', 'F', 'Расходы на услуги банков', '23503', '(947)', '(8 303)', 'Прочие операционные расходы', '23504', '(63 037)', '(68 242)', 'Штрафы, пени, неустойки к уплате', '23505', '(4171)', '(229)', 'Налоги и сборы', '23506', '(20828)', '(69)', 'Расходы в виде списанной дебиторской', '23507', 'задолженности', '(5010)', '(16 786)', 'Прочие внереализационные расходы', '23508', '(11 060)', '(1191)', 'Прочие косвенные расходы', '23509', '-', 'Прибыль (убыток) до налогообложения', '2300', '9 124', '2952', 'Налог на прибыль', '2410', '(2 106)', '(678)', 'в том числе:', 'текущий налог на прибыль', '2411', '(2 106)', '(678)', 'отложенный налог на прибыль', '2412', '-', '-', 'Прочее', '2460', '-', 'Чистая прибыль (убыток)', '2400', '7018', '2274'],
      ['Форма 0710002 с.2', 'Пояснения', 'Наименование показателя', 'Код', 'За Январь -', 'За Январь -', 'Сентябрь 2024 г.', 'Сентябрь 2023 г.', 'Результат от переоценки внеоборотных активов, не', 'включаемый в чистую прибыль (убыток) периода', '2510', 'Результат от прочих операций, не включаемый', 'в чистую прибыль (убыток) периода', '2520', 'Налог на прибыль от операций, результат которых', '-', 'не включается в чистую прибыль (убыток) периода', '2530', 'Совокупный финансовый результат периода', '2500', '-', '7018', '2274', 'Справочно', '2900', 'Базовая прибыль (убыток) на акцию', 'Разводненная прибыль (убыток) на акцию', '-', '2910', '-', '-', '-', '', '5431', '', 'Иванова Татьяна', 'Руководитель', 'Николаевна', '(подпись)', '(расшифровка подписи)', '30 октября 2024 г.']
    ];

    const result = parsePageContent(pageContents);
    
    expect(result.error).toBeUndefined();
    expect(Array.isArray(result.otchetnost)).toBe(true);
    
    const foundCodes = new Set(result.otchetnost.map(r => r.code));
    expect(foundCodes.has('2110')).toBe(true);
    expect(foundCodes.has('2120')).toBe(true);
    expect(foundCodes.has('2100')).toBe(true);
    expect(foundCodes.has('2200')).toBe(true);
    expect(foundCodes.has('2400')).toBe(true);
    
    const code2110 = result.otchetnost.filter(r => r.code === '2110');
    expect(code2110).toHaveLength(2);
    expect(code2110.find(r => r.date === '2024-09-30').sum).toBe(1327023);
    expect(code2110.find(r => r.date === '2023-09-30').sum).toBe(1309986);
    
    const code2120 = result.otchetnost.filter(r => r.code === '2120');
    expect(code2120.find(r => r.date === '2024-09-30').sum).toBe(-1196001);
    expect(code2120.find(r => r.date === '2023-09-30').sum).toBe(-1211618);
  });
});